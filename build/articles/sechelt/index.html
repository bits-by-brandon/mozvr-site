<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>Sechelt - Web VR
    </title>
    <link rel="alternate" href="http://localhost:8080/feed.xml" type="application/rss+xml" title="Wherever you go, there you are.">
    <link rel="stylesheet" href="http://code.cdn.mozilla.net/fonts/fira.css">
    <link rel="stylesheet" href="/css/main.css">
  </head>
  <body class="article-detail">
    <header class="header">
      <div class="content-wrap">
        <h1>Sechelt</h1>
                <div id="creators">Created by
                  <ul>
                    <li><a href="http://twitter.com/mrdoob" target="blank">Ricardo Cabello</a></li>
                    <li><a href="http://twitter.com/joshcarpenter" target="blank">Josh Carpenter</a></li>
                  </ul>
                </div>
                <!--if tools are listed, create one li for each-->
                <!--else don't do anything-->
                <div id="tools">Tools
                  <ul>
                    <li><a href="http://threejs.org/">Three.js</a></li>
                    <li><a href="http://www.maxon.net/">Cinema 4D</a></li>
                  </ul>
                </div>
        <p class="repo"><a href="https://github.com/potch/JAVRIS">Source</a></p>
      </div>
    </header>
    <div id="content">
      <div class="content-wrap">
        <article class="article">
          <section class="content"><p><img src="/build/articles/sechelt/c4d-5.png" alt=""></p>
<p>A collaboration with Ricardo Cabello of Three.js. Inspired by the coastline of British Columbia and the work of Roy Henry Vickers. Created with Cinema 4D,&nbsp;Three.js.</p>
<!-- tools: [ "Three.js", "Cinema4D" ] -->

<h2 id="basic-workflow">Basic&nbsp;workflow</h2>
<p>The high level process that brough Sechelt to&nbsp;life:</p>
<ul>
<li>Scene modeled in Cinema&nbsp;4D</li>
<li>Scene optimized by combinig geometries and eliminating unnecessary&nbsp;materials.</li>
<li>Scene models exported from Cinema 4D to Collada&nbsp;.<span class="caps">DAE</span>.</li>
<li><span class="caps">DAE</span> file opened in <a href="http://threejs.org/editor/">Three.js&nbsp;Editor</a></li>
<li>Scene setup, animation, interactivity and sound created in <a href="http://threejs.org">Three.js</a></li>
<li><span class="caps">VR</span> support implemented with VRControls and VREffect Three.js&nbsp;extras.</li>
</ul>
<h2 id="pre-production">Pre&nbsp;Production</h2>
<h3 id="inspiration-and-art-direction">Inspiration and art&nbsp;direction</h3>
<p>Sechelt as location using Google Earth
Roy Henry Vickers
Doug Coupland’s take on the coast of <span class="caps">BC</span>
Journey, Shape of the World&nbsp;Sketches</p>
<p><a href="http://www.royhenryvickers.com/">Roy Henry Vickers</a>:</p>
<p><img src="/build/articles/sechelt/artdirection-rhv.png" alt="Roy Henry Vickers"></p>
<p>Douglas&nbsp;Coupland:</p>
<p><img src="/build/articles/sechelt/artdirection-dc.png" alt="Douglas Coupland"></p>
<p><img src="/build/articles/sechelt/photo1.jpg" alt=""></p>
<h3 id="scouting-a-location">Scouting a&nbsp;location</h3>
<p>It was important to us to capture the reality of <span class="caps">BC</span>’s coastal landscape, with its steep glacier-carved valleys and it’s uncountable forested islands, stretching north from Vancouver to Alaska. To find a location, we used Google Earth to identify promising flight paths and vistas, eventually settling on a path stretching south from a mountain peak to the town of&nbsp;Sechelt.</p>
<p><img src="/build/articles/sechelt/googleearth-2.png" alt="The Sechelt scene "></p>
<p><img src="/build/articles/sechelt/map1.png" alt="The Motion Camera settings"></p>
<h2 id="cinema-4d">Cinema&nbsp;4D</h2>
<h3 id="modeling-and-lighting">Modeling and&nbsp;lighting</h3>
<p>This landscape was then modeled in Cinema 4D using the sculpt tool. Getting the lighting right was critical to achieving the desired look, and performance was a concern, so we opted to use a shader-based system. There are no lights in the scene. The landscape, water, trees etc are all colored with shaders. The fade of the landscape, from purple to light blue as it stretches into the distance, was achieved with a Gradient shader in the landscape material’s Luminance channel. The shader is a set to 2000cm, and mapped to the position of the camera, making objects close to the camera dark, and objects further away progressively&nbsp;lighter.</p>
<p><img src="/build/articles/sechelt/c4d-1.png" alt="The Cinema 4D setup "></p>
<h3 id="camera-animation">Camera&nbsp;animation</h3>
<p>The camera animation was defined with Cinema 4D’s Motion Camera tool. A spline was carefully modeled, sweeping through the scene. The Motion Camera’s path was set to the spline, and the Camera Position then animated from 0 to 100$. At the end I wanted the camera to come to rest in a very precise position, which proved difficult to achieve by tweaking the spline points. So we instead created a second camera, framed it just right, then set the Motion Camera to switch between aligning itself to the spline, and aligning itself to this second camera, at the very end of the sequence. The final effect was&nbsp;seamless.</p>
<p><img src="/build/articles/sechelt/c4d-6.png" alt="The Motion Camera settings"></p>
<h3 id="exporting-the-cinema-4d-assets">Exporting the Cinema 4D&nbsp;assets</h3>
<p>To exporting the assets from Cinema 4D to Three.js it was important to get several things right, or we found the results were unwieldy, mismatched, slow, etc. The steps we took were&nbsp;to:</p>
<h4 id="1-adjust-the-scale">1. Adjust the&nbsp;scale</h4>
<p>The original scene was modeled to match the actual landscape, in meters. This made the units too massive to easily handle, however, so we scaled the scene down to centimeters before&nbsp;exporting.</p>
<h4 id="2-reduce-the-number-of-individual-objects-by-merging">2. Reduce the number of individual objects by&nbsp;merging</h4>
<p>In Cinema 4D the trees were dozens of individual objects each with their own instance of the tree material. It is important to reduce the number of unique geometries and materials when working with Three.js, however, for both performance and logistics reasons. So before we exported the scene, we deleted any unused objects and merged the trees into one single object with one material&nbsp;instance.</p>
<h4 id="3-clean-up-the-geometry">3. Clean up the&nbsp;geometry</h4>
<p>If the camera was not going to see something, we deleted it. The meant carving out sections of the landscape, such as the backside of the mountains flanking the&nbsp;vallies.</p>
<p><img src="/build/articles/sechelt/c4d-4.png" alt="The final Sechelt model landscape model. The white line is the camera&#39;s path. "></p>
<h2 id="three-js-implementation">Three.js&nbsp;Implementation</h2>
<h3 id="importing-scene-models">Importing scene&nbsp;models</h3>
<p>We recreated the Cinema 4D scene in Three.js by importing the objects inside the .<span class="caps">DAE</span> file with the&nbsp;following:</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> loader = <span class="keyword">new</span> <span class="caps">THREE</span>.ObjectLoader();
loader.load( <span class="string">'c4d-scene.json'</span>, <span class="function"><span class="keyword">function</span> <span class="params">( object )</span> {</span>

  <span class="keyword">var</span> landscape = object.getObjectByName( <span class="string">'lanscape'</span> );

  <span class="keyword">var</span> reflection = <span class="keyword">new</span> <span class="caps">THREE</span>.Mesh( landscape.geometry, landscape.material.clone() );
  reflection.material.side = THREE.BackSide;
  reflection.position.y = <span class="number">7.7</span>;
  reflection.scale.y = -<span class="number">1</span>;
  landscape.parent.add( reflection );

  scene.add( object );

} );
</code></pre>
<p>To create the effect of the lanscape reflecting on the “water”, Ricardo actually duplicated the landscape, inverted it on the Y-axis, and moved it down. This seems more convoluted than simply created a water surface with a reflection shader (as we did in the original Cinema 4D scene), but within WebGL this approach is faster and enables finer control over the look of the reflection by modifying the reflection object’s materials and other scene&nbsp;objects.</p>
<h3 id="ambient-sounds">Ambient&nbsp;sounds</h3>
<p>As the user moves through the scene they hear waves, wildlife, and wind. These sounds are mapped to the environment itself, helping to create a sense of immersion within the 3D world. This effect was achieved by Ricardo, who created null objects in the 3D world, mapped sounds to them, and mapped the playback volume of the sounds to the distance of the user. Sound clips were sourced from <a href="http://www.freesound.org">Freesound.org</a>.</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> listener = <span class="keyword">new</span> <span class="caps">THREE</span>.AudioListener();
camera.add( listener );

<span class="keyword">var</span> sound = <span class="keyword">new</span> <span class="caps">THREE</span>.Audio( listener );
sound.load( <span class="string">'sounds/78389__inchadney__seagulls.ogg'</span> );
sound.position.set( <span class="number">475</span>, <span class="number">50</span>, <span class="number">850</span> );
sound.setLoop( <span class="literal">true</span> );
sound.setRefDistance( <span class="number">100</span> );
scene.add( sound );
</code></pre>
<h3 id="camera-system">Camera&nbsp;system</h3>
<p>We were inspired by the app Eden River to implement a control scheme that was completely hands free and intuitive. As users fly through the Sechelt scene, their position travels along the path that was defined in Cinema 4D. By tilting their head, however, they can “bank” the camera, like a plane, to steer left and right, deviating slightly in the direction they wish to go. This feels a bit like flying a plane. We love this control scheme because 1) it takes advantage of the head set’s innate head tracking capabilities, 2) it is entirely optional, with new users able to enjoy their experience even if they never discover the head-tilt mechanic, 3) it does not require an external input device, and 4) it is so&nbsp;satisfying.</p>
<p>Ricardo implemented this control scheme in Three.js by creating a dolly system that tracks both the user’s headset data and the position of the camera on the pre-defined path, and then averages&nbsp;them.</p>
<pre><code class="lang-javascript"><span class="keyword">if</span> ( cameraPath !== <span class="literal">undefined</span> ) {

  <span class="keyword">var</span> time = ( performance.now() / <span class="number">40000</span> ) % <span class="number">1</span>;

  <span class="keyword">var</span> pointA = cameraPath.getPointAt( time );
  <span class="keyword">var</span> pointB = cameraPath.getPointAt( <span class="built_in">Math</span>.min( time + <span class="number">0.015</span>, <span class="number">1</span> ) );

  pointA.z = -pointA.z;
  pointB.z = -pointB.z;

  dolly.position.copy( pointA );
  dolly.lookAt( pointB );

  dolly.rotateY( <span class="built_in">Math</span>.<span class="caps">PI</span> ); <span class="comment">// look forward</span>

}

controls.update();

sky.position.copy( dolly.position );

water.position.x = dolly.position.x;
water.position.z = dolly.position.z;

effect.render( scene, camera );
</code></pre>
<p>To bring camera data from Cinema 4D into Three.js, we exported the individual points that define the camera path in <span class="caps">C4D</span> as ASCII text, and then imported them into Three.js using an importer that Ricardo&nbsp;wrote:</p>
<pre><code class="lang-javascript"><span class="keyword">var</span> loader = <span class="keyword">new</span> <span class="caps">THREE</span>.C4DLineLoader();
loader.load( <span class="string">'flightpath-ascii.txt'</span>, <span class="function"><span class="keyword">function</span> <span class="params">( line )</span> {</span>

  cameraPath = line;

} );
</code></pre>
<h2 id="testing-optimization">Testing <span class="amp">&amp;</span>&nbsp;Optimization</h2>
<h3 id="adding-vr-headset-support">Adding <span class="caps">VR</span> headset&nbsp;support</h3>
<p>Support for <span class="caps">VR</span> headsets was implemented with two Three.js components: VRControls and VREffect. These take the scene&nbsp;and…</p>
<h3 id="testing">Testing</h3>
<p>We tested the results with <span class="caps">DK1</span> and DK2 headsets and random co-workers, trying to find people who were particularly sensitive to the nauseau and disorientation that VR can produce if not properly&nbsp;calibrated.</p>
<h3 id="deployment">Deployment</h3>
<p>For the start of the development process we simple worked out of a Dropbox folder, with Ricardo saving this progress as he went. Our standard process is to use Git, <span class="caps">NPM</span> and Gulp track changes, manage dependencies and automate various development tasks, but early in the process we were more concerned with quick results, and with just Ricardo doing the code a simple setup was good enough. Before deploying, however, we organized the code and pushed to GitHub, hosting everything with gh-pages, using <a href="https://www.npmjs.org/package/gulp-gh-pages">gulp-gh-pages</a> to automate the&nbsp;process.</p>
</section>
        </article>By
        <div class="author">
                  <div class="author"><img src="/authors/josh.png">
                    <div><b>Josh Carpenter</b>
                      <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua</p>
                      <div><a href="mailto:jcarpenter@mozilla.com">jcarpenter@mozilla.com</a></div>
                      <div><a href="@joshcarpenter">@joshcarpenter</a></div>
                    </div>
                  </div>
        </div>
      </div>
    </div>
    <footer>
      <div class="content-wrap">
        <section class="about"><p>Wintersmith is made by <a href="http://johan-nordberg.com">Johan Nordberg</a> and licensed under the <a href="http://opensource.org/licenses/MIT">MIT-license</a>.
This footer text can be edited in about.md</p>
<p>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod
tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam,
quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo
consequat.</p>
<p>Duis aute irure dolor in reprehenderit in voluptate velit esse cillum
dolore eu fugiat nulla pariatur.</p>
<p>Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia
deserunt mollit anim id est laborum.</p>

        </section>
        <section class="copy">
          <p>&copy; 2014 Mozilla Research &mdash; powered by&nbsp;<a href="https://github.com/jnordberg/wintersmith">Wintersmith</a>
          </p>
        </section>
      </div>
    </footer>
  </body>
</html>